<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>codename-backend documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">codename-backend documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content controller">
                   <div class="content-data">





<ol class="breadcrumb">
  <li class="breadcrumb-item">Controllers</li>
  <li class="breadcrumb-item" >OpenIDConnectController</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/identity/authentication/controllers/OpenIDConnect.controller.ts</code>
        </p>

            <p class="comment">
                <h3>Prefix</h3>
            </p>
            <p class="comment">
                <code>open-id-connect</code>
            </p>






            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getExternalIdentityCookieOptions" >getExternalIdentityCookieOptions</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getOIDCCookieOptions" >getOIDCCookieOptions</a>
                            </li>
                            <li>
                                    <span class="modifier"></span>
                                    <span class="modifier"></span>
                                    <span class="modifier"></span>
                                    <span class="modifier">Async</span>
                                <a href="#login" >login</a>
                            </li>
                            <li>
                                    <span class="modifier"></span>
                                    <span class="modifier"></span>
                                    <span class="modifier"></span>
                                    <span class="modifier">Async</span>
                                <a href="#loginCallback" >loginCallback</a>
                            </li>
                            <li>
                                    <span class="modifier"></span>
                                    <span class="modifier"></span>
                                    <span class="modifier"></span>
                                    <span class="modifier">Async</span>
                                <a href="#registerWithOIDC" >registerWithOIDC</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getExternalIdentityCookieOptions"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getExternalIdentityCookieOptions</b></span>
                        <a href="#getExternalIdentityCookieOptions"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getExternalIdentityCookieOptions()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="208"
                                    class="link-to-prism">src/modules/identity/authentication/controllers/OpenIDConnect.controller.ts:208</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/variables.html#Cookie" target="_self" >CookieSerializeOptions</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getOIDCCookieOptions"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getOIDCCookieOptions</b></span>
                        <a href="#getOIDCCookieOptions"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getOIDCCookieOptions()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="197"
                                    class="link-to-prism">src/modules/identity/authentication/controllers/OpenIDConnect.controller.ts:197</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/variables.html#Cookie" target="_self" >CookieSerializeOptions</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="login"></a>
                    <span class="name">
                            <span class="modifier"></span>
                            <span class="modifier"></span>
                            <span class="modifier"></span>
                            <span class="modifier">Async</span>
                        <span ><b>login</b></span>
                        <a href="#login"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>login(response: FastifyReply, providerId: <a href="../undefineds/FederatedAccountProvider.html" target="_self">FederatedAccountProvider</a>, loginRedirectUrl: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, registerRedirectUrl: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@HttpCode(HttpStatus.OK)<br />@Get(&#x27;login/:providerId&#x27;)<br />@Throttle(IDENTITY_MODULE_STRICT_RATE_LIMITING)<br /></code>
                </td>
            </tr>

                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="81"
                                    class="link-to-prism">src/modules/identity/authentication/controllers/OpenIDConnect.controller.ts:81</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>response</td>
                                            <td>
                                                        <code>FastifyReply</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>providerId</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#FederatedAccountProvider" target="_self" >FederatedAccountProvider</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>loginRedirectUrl</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>registerRedirectUrl</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="loginCallback"></a>
                    <span class="name">
                            <span class="modifier"></span>
                            <span class="modifier"></span>
                            <span class="modifier"></span>
                            <span class="modifier">Async</span>
                        <span ><b>loginCallback</b></span>
                        <a href="#loginCallback"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>loginCallback(response: FastifyReply, providerId: <a href="../undefineds/FederatedAccountProvider.html" target="_self">FederatedAccountProvider</a>, code: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, state: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, storedState: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, storedCodeVerifier: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@HttpCode(HttpStatus.OK)<br />@Get(&#x27;login/:providerId/callback&#x27;)<br />@SkipThrottle()<br /></code>
                </td>
            </tr>

                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="110"
                                    class="link-to-prism">src/modules/identity/authentication/controllers/OpenIDConnect.controller.ts:110</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>response</td>
                                            <td>
                                                        <code>FastifyReply</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>providerId</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#FederatedAccountProvider" target="_self" >FederatedAccountProvider</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>code</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>state</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>storedState</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>storedCodeVerifier</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="registerWithOIDC"></a>
                    <span class="name">
                            <span class="modifier"></span>
                            <span class="modifier"></span>
                            <span class="modifier"></span>
                            <span class="modifier">Async</span>
                        <span ><b>registerWithOIDC</b></span>
                        <a href="#registerWithOIDC"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>registerWithOIDC(response: FastifyReply, _dto: <a href="../classes/RegisterViaOIDCDto.html" target="_self">RegisterViaOIDCDto</a>, externalIdentity: <a href="../classes/ExternalIdentityDto.html" target="_self">ExternalIdentityDto</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@HttpCode(HttpStatus.CREATED)<br />@Post(&#x27;register&#x27;)<br />@Throttle(IDENTITY_MODULE_STRICT_RATE_LIMITING)<br /></code>
                </td>
            </tr>

                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="165"
                                    class="link-to-prism">src/modules/identity/authentication/controllers/OpenIDConnect.controller.ts:165</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>response</td>
                                            <td>
                                                        <code>FastifyReply</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>_dto</td>
                                            <td>
                                                            <code><a href="../classes/RegisterViaOIDCDto.html" target="_self" >RegisterViaOIDCDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>externalIdentity</td>
                                            <td>
                                                            <code><a href="../classes/ExternalIdentityDto.html" target="_self" >ExternalIdentityDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { CookieSerializeOptions } from &quot;@fastify/cookie&quot;;
import {
    BadRequestException,
    Body,
    ConflictException,
    Controller,
    Get,
    HttpCode,
    HttpStatus,
    Inject,
    Param,
    ParseEnumPipe,
    Post,
    Query,
    Res,
    UnauthorizedException,
} from &quot;@nestjs/common&quot;;
import { ConfigService } from &quot;@nestjs/config&quot;;
import { SkipThrottle, Throttle } from &quot;@nestjs/throttler&quot;;
import { OAuth2RequestError } from &quot;arctic&quot;;
import { type FastifyReply } from &quot;fastify&quot;;

import { Cookie } from &quot;@/common/decorators/Cookie.decorator&quot;;
import { EntityConflictError } from &quot;@/common/errors/EntityConflict.error&quot;;
import { EntityNotFoundError } from &quot;@/common/errors/EntityNotFound.error&quot;;
import { ForbiddenError } from &quot;@/common/errors/Forbidden.error&quot;;
import { whenError } from &quot;@/common/errors/whenError&quot;;
import { type IDomainVerifierService, DomainVerifierServiceToken } from &quot;@/common/services/interfaces/IDomainVerifier.service&quot;;
import {
    OIDC_CODE_VERIFIER_COOKIE_NAME,
    OIDC_EXTERNAL_IDENTITY,
    OIDC_STATE_COOKIE_NAME,
    REFRESH_TOKEN_COOKIE_NAME,
} from &quot;@/modules/identity/authentication/constants&quot;;
import { ExternalIdentityDto } from &quot;@/modules/identity/authentication/dto/incoming/ExternalIdentity.dto&quot;;
import { RegisterViaOIDCDto } from &quot;@/modules/identity/authentication/dto/incoming/RegisterViaOIDC.dto&quot;;
import { UntrustedDomainError } from &quot;@/modules/identity/authentication/errors/UntrustedDomain.error&quot;;
import { type IAuthenticationMapper, AuthenticationMapperToken } from &quot;@/modules/identity/authentication/mappers/IAuthentication.mapper&quot;;
import {
    type IAuthenticationService,
    AuthenticationServiceToken,
} from &quot;@/modules/identity/authentication/services/interfaces/IAuthentication.service&quot;;
import {
    type IOIDCProviderFactory,
    OIDCProviderFactoryToken,
} from &quot;@/modules/identity/authentication/services/interfaces/IOIDCProvider.factory&quot;;
import {
    type IRefreshTokenCookieStrategy,
    RefreshTokenCookieStrategyToken,
} from &quot;@/modules/identity/authentication/strategies/refreshToken/IRefreshTokenCookie.strategy&quot;;
import { FederatedAccountProvider } from &quot;@/modules/identity/authentication/types/ManagedAccountProvider&quot;;
import { type ExternalIdentity } from &quot;@/modules/identity/authentication/types/OpenIDConnect&quot;;
import { IDENTITY_MODULE_DEFAULT_RATE_LIMITING, IDENTITY_MODULE_STRICT_RATE_LIMITING } from &quot;@/modules/identity/shared/constants&quot;;

@Throttle(IDENTITY_MODULE_DEFAULT_RATE_LIMITING)
@Controller(&quot;open-id-connect&quot;)
export class OpenIDConnectController {
    private readonly refreshTokenCookieMaxAge: number;
    private readonly oidcCookieMaxAge: number;

    public constructor(
        @Inject(DomainVerifierServiceToken)
        private readonly domainVerifier: IDomainVerifierService,
        @Inject(OIDCProviderFactoryToken)
        private readonly oidcProviderFactory: IOIDCProviderFactory,
        @Inject(AuthenticationMapperToken)
        private readonly authenticationMapper: IAuthenticationMapper,
        @Inject(RefreshTokenCookieStrategyToken)
        private readonly refreshTokenCookieStrategy: IRefreshTokenCookieStrategy,
        @Inject(AuthenticationServiceToken)
        private readonly authService: IAuthenticationService,
        configService: ConfigService
    ) {
        this.refreshTokenCookieMaxAge &#x3D; configService.getOrThrow&lt;number&gt;(&quot;modules.identity.refreshToken.expirationTimeInSeconds&quot;) * 1000;
        this.oidcCookieMaxAge &#x3D; configService.getOrThrow&lt;number&gt;(&quot;modules.identity.oidc.cookie.expirationTimeInSeconds&quot;) * 1000;
    }

    @HttpCode(HttpStatus.OK)
    @Get(&quot;login/:providerId&quot;)
    @Throttle(IDENTITY_MODULE_STRICT_RATE_LIMITING)
    async login(
        @Res() response: FastifyReply,
        @Param(&quot;providerId&quot;, new ParseEnumPipe(FederatedAccountProvider))
        providerId: FederatedAccountProvider,
        @Query(&quot;loginRedirectUrl&quot;) loginRedirectUrl: string,
        @Query(&quot;registerRedirectUrl&quot;) registerRedirectUrl: string
    ) {
        if (!this.domainVerifier.verify(registerRedirectUrl)) {
            throw new UntrustedDomainError(registerRedirectUrl);
        }

        if (!this.domainVerifier.verify(registerRedirectUrl)) {
            throw new UntrustedDomainError(registerRedirectUrl);
        }

        const provider &#x3D; this.oidcProviderFactory.create(providerId);
        const { codeVerifier, url, state } &#x3D; provider.startAuthorizationProcess({
            loginRedirectUrl: loginRedirectUrl,
            registerRedirectUrl: registerRedirectUrl,
        });

        response.setCookie(OIDC_CODE_VERIFIER_COOKIE_NAME, codeVerifier, this.getOIDCCookieOptions());
        response.setCookie(OIDC_STATE_COOKIE_NAME, state, this.getOIDCCookieOptions());
        return response.send(this.authenticationMapper.toOIDCRedirectDTO(url));
    }

    @HttpCode(HttpStatus.OK)
    @Get(&quot;login/:providerId/callback&quot;)
    @SkipThrottle()
    async loginCallback(
        @Res() response: FastifyReply,
        @Param(&quot;providerId&quot;, new ParseEnumPipe(FederatedAccountProvider))
        providerId: FederatedAccountProvider,
        @Query(&quot;code&quot;) code: string,
        @Query(&quot;state&quot;) state: string,
        @Cookie(OIDC_STATE_COOKIE_NAME) storedState: string,
        @Cookie(OIDC_CODE_VERIFIER_COOKIE_NAME) storedCodeVerifier: string
    ) {
        const provider &#x3D; this.oidcProviderFactory.create(providerId);
        const decodedState &#x3D; provider.validateAuthorizationResponse({
            code,
            state,
            storedCodeVerifier,
            storedState,
        });

        if (!decodedState) {
            throw new BadRequestException();
        }

        const { registerRedirectUrl } &#x3D; decodedState;
        const loginRedirectUrl &#x3D; new URL(decodedState.loginRedirectUrl);

        let externalIdentity: ExternalIdentity | null &#x3D; null;

        try {
            externalIdentity &#x3D; await provider.getIdentity(code, storedCodeVerifier);
            response.setCookie(OIDC_EXTERNAL_IDENTITY, JSON.stringify(externalIdentity), this.getExternalIdentityCookieOptions());

            const { accessToken, refreshToken, account, accessScopes } &#x3D; await this.authService.loginWithExternalIdentity(externalIdentity);
            const cookieOptions &#x3D; this.refreshTokenCookieStrategy.getCookieOptions(this.refreshTokenCookieMaxAge);

            response.setCookie(REFRESH_TOKEN_COOKIE_NAME, refreshToken, cookieOptions);
            loginRedirectUrl.searchParams.set(&quot;accessToken&quot;, accessToken);
            loginRedirectUrl.searchParams.set(&quot;accessScopes&quot;, encodeURIComponent(JSON.stringify(accessScopes)));
            loginRedirectUrl.searchParams.set(&quot;account&quot;, encodeURIComponent(JSON.stringify(account)));
        } catch (err) {
            if (err instanceof EntityNotFoundError &amp;&amp; !!externalIdentity) {
                return response.status(HttpStatus.FOUND).redirect(registerRedirectUrl);
            }

            if (err instanceof ForbiddenError &amp;&amp; !!externalIdentity) {
                loginRedirectUrl.searchParams.set(&quot;error&quot;, &quot;ACCOUNT_SUSPENDED&quot;);
            } else {
                loginRedirectUrl.searchParams.set(&quot;error&quot;, &quot;UNKNOWN&quot;);
            }
        }

        return response.status(HttpStatus.FOUND).redirect(loginRedirectUrl.toString());
    }

    @HttpCode(HttpStatus.CREATED)
    @Post(&quot;register&quot;)
    @Throttle(IDENTITY_MODULE_STRICT_RATE_LIMITING)
    async registerWithOIDC(
        @Res() response: FastifyReply,
        @Body() _dto: RegisterViaOIDCDto,
        @Cookie({
            name: OIDC_EXTERNAL_IDENTITY,
            signed: true,
            parseAs: ExternalIdentityDto,
        })
        externalIdentity: ExternalIdentityDto
    ) {
        const provider &#x3D; this.oidcProviderFactory.create(externalIdentity.providerId);

        if (!provider.validateExternalIdentity(externalIdentity)) {
            throw new UnauthorizedException();
        }

        try {
            const result &#x3D; await this.authService.registerWithExternalIdentity(externalIdentity);
            const cookieOptions &#x3D; this.refreshTokenCookieStrategy.getCookieOptions(this.refreshTokenCookieMaxAge);

            response.setCookie(REFRESH_TOKEN_COOKIE_NAME, result.refreshToken, cookieOptions);
            return response.send(this.authenticationMapper.toAuthenticationResultDTO(result));
        } catch (err) {
            whenError(err)
                .is(OAuth2RequestError)
                .throw(new UnauthorizedException())
                .is(EntityConflictError)
                .throw(new ConflictException())
                .elseRethrow();
        }
    }

    private getOIDCCookieOptions(): CookieSerializeOptions {
        return {
            partitioned: true,
            httpOnly: true,
            secure: true,
            maxAge: this.oidcCookieMaxAge,
            sameSite: &quot;lax&quot;,
            path: &quot;/&quot;,
        };
    }

    private getExternalIdentityCookieOptions(): CookieSerializeOptions {
        return {
            partitioned: true,
            httpOnly: true,
            secure: true,
            maxAge: this.oidcCookieMaxAge,
            sameSite: &quot;strict&quot;,
            path: &quot;/api/open-id-connect/register&quot;,
            signed: true,
        };
    }
}
</code></pre>
    </div>
</div>
















                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'controller';
            var COMPODOC_CURRENT_PAGE_URL = 'OpenIDConnectController.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
