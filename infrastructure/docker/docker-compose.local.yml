version: "3.4"
services:
    tunnel:
        command:
            - "http"
            - "--url=${NGROK_DOMAIN}"
            - "http://host.docker.internal:${GATEWAY_PORT}"
        environment:
            - NGROK_AUTHTOKEN=${NGROK_AUTH_TOKEN}
        ports:
            - "${NGROK_PORT}:4040"

    db:
        environment:
            - POSTGRES_USER=${DATABASE_USERNAME}
            - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
            - POSTGRES_DB=db
        ports:
            - "5432:5432"
        volumes:
            - postgres:/var/lib/postgresql/data
                
    pooler:
        environment:
            - PGBOUNCER_POOL_MODE=transaction
            - PGBOUNCER_QUERY_WAIT_TIMEOUT=60
            - PGBOUNCER_MAX_CLIENT_CONN=10000
            - PGBOUNCER_DEFAULT_POOL_SIZE=20
            - PGBOUNCER_STATS_USERS=${DATABASE_USERNAME}
            - POSTGRESQL_USERNAME=${DATABASE_USERNAME}
            - POSTGRESQL_PASSWORD=${DATABASE_PASSWORD}
            - PGBOUNCER_DATABASE=*
            - POSTGRESQL_HOST=db
            - POSTGRESQL_PORT=5432
        ports:
            - "${DATABASE_PORT}:6432"

    pubsub:
        ports:
            - "${PUBSUB_PORT}:4222"
            - "8222:8222"
        command: ["-js", "-m", "8222"]

    gateway:
        ports:
            - "${GATEWAY_PORT}:80"
            - "5010:9901"
        environment:
            - BACKEND_ADDRESS=${BACKEND_HOST}
            - BACKEND_PORT=80
            - FRONTEND_ADDRESS=${FRONTEND_HOST}
            - FRONTEND_PORT=80
            - ALLOWED_ORIGINS=${GATEWAY_ALLOWED_ORIGINS}

    frontend:
        ports:
            - "${FRONTEND_PORT}:80"
        environment:
            - PORT=80
            - NEXT_PUBLIC_API_URL=${GATEWAY_URL}

    backend:
        ports:
            - "${BACKEND_PORT}:80"
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:80/healthz/liveness" ]
            start_period: 30s
            interval: 15s
            timeout: 5s
            retries: 3
        environment:
            - APP_NAME=${APP_NAME}
            - EVENTS_ENCRYPTION_SECRET_64_BYTES=${EVENTS_ENCRYPTION_SECRET_64_BYTES}

            - CLIENT_URL_BASE=${CLIENT_URL_BASE}

            - RATE_LIMITING_BASE_LIMIT=${RATE_LIMITING_BASE_LIMIT}
            - RATE_LIMITING_BASE_TTL=${RATE_LIMITING_BASE_TTL}

            - PUBSUB_HOST=${PUBSUB_HOST}
            - PUBSUB_PORT=${PUBSUB_PORT}

            - DATABASE_LOGGING_ENABLED=${DATABASE_LOGGING_ENABLED}
            - DATABASE_PORT=${DATABASE_PORT}
            - DATABASE_USERNAME=${DATABASE_USERNAME}
            - DATABASE_PASSWORD=${DATABASE_PASSWORD}
            - DATABASE_HOST=${DATABASE_HOST}

            - PORT=80
            - JWT_SIGNING_SECRET=${JWT_SIGNING_SECRET}
            - JWT_EXPIRATION_TIME_IN_SECONDS=${JWT_EXPIRATION_TIME_IN_SECONDS}
            - OIDC_COOKIE_EXPIRATION_TIME_IN_SECONDS=${OIDC_COOKIE_EXPIRATION_TIME_IN_SECONDS}
            - REFRESH_TOKEN_SIGNING_SECRET=${REFRESH_TOKEN_SIGNING_SECRET}
            - REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS=${REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS}

            - AUTH_DATABASE_NAME=${AUTH_DATABASE_NAME}
            - AUTH_THROTTLE_LIMIT=${AUTH_THROTTLE_LIMIT}
            - AUTH_THROTTLE_TTL_IN_MS=${AUTH_THROTTLE_TTL_IN_MS}

            - USERS_DATABASE_NAME=${USERS_DATABASE_NAME}

            - MAIL_SENDER_NAME=${MAIL_SENDER_NAME}
            - MAIL_SENDER_USER=${MAIL_SENDER_USER}
            - MAIL_SENDER_PASSWORD=${MAIL_SENDER_PASSWORD}
            - MAIL_SENDER_HOST=${MAIL_SENDER_HOST}
            - MAIL_SENDER_PORT=${MAIL_SENDER_PORT}
            - MAIL_DEBUG_MODE=${MAIL_DEBUG_MODE}

            - MAIL_DATABASE_NAME=${MAIL_DATABASE_NAME}

            - ALERTS_DATABASE_NAME=${ALERTS_DATABASE_NAME}

            - GDPR_DATABASE_NAME=${GDPR_DATABASE_NAME}

            - JOURNAL_DATABASE_NAME=${JOURNAL_DATABASE_NAME}

            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            - GOOGLE_OIDC_REDIRECT_URL=${GOOGLE_OIDC_REDIRECT_URL}

            - COOKIES_SECRET=${COOKIES_SECRET}
