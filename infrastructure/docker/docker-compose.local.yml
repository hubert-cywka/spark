version: "3.4"
services:
    tunnel:
        command:
            - "http"
            - "--url=${NGROK_DOMAIN}"
            - "http://host.docker.internal:${GATEWAY_PORT}"
        environment:
            NGROK_AUTHTOKEN: ${NGROK_AUTH_TOKEN}
        ports:
            - "${NGROK_PORT}:4040"

    db:
        environment:
            POSTGRES_USER: ${DATABASE_USERNAME}
            POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
            POSTGRES_DB: "db"
        ports:
            - "${DATABASE_PORT}:5432"
        volumes:
            - postgres:/var/lib/postgresql/data

    pubsub:
        ports:
            - "${PUBSUB_PORT}:4222"
            - "8222:8222"
        command: ["-js", "-m", "8222"]

    gateway:
        ports:
            - "${GATEWAY_PORT}:80"
            - "5010:9901"
        environment:
            - JOURNAL_SERVICE_ADDRESS=journal-service
            - JOURNAL_SERVICE_PORT=80
            - MAIL_SERVICE_ADDRESS=mail-service
            - MAIL_SERVICE_PORT=80
            - USER_SERVICE_ADDRESS=user-service
            - USER_SERVICE_PORT=80
            - ALERT_SERVICE_ADDRESS=alert-service
            - ALERT_SERVICE_PORT=80
            - IDENTITY_SERVICE_ADDRESS=identity-service
            - IDENTITY_SERVICE_PORT=80
            - FRONTEND_ADDRESS=${FRONTEND_HOST}
            - FRONTEND_PORT=80
            - ALLOWED_ORIGINS=${GATEWAY_ALLOWED_ORIGINS}

    frontend:
        ports:
            - "${FRONTEND_PORT}:80"
        environment:
            - PORT=80
            - NEXT_PUBLIC_API_URL=${GATEWAY_URL}

    alert-service:
        ports:
            - "5600:80"
        environment:
            - CLIENT_URL_BASE=${CLIENT_URL_BASE}
            - CLIENT_ACCOUNT_ACTIVATION_PAGE=${CLIENT_ACCOUNT_ACTIVATION_PAGE}
            - CLIENT_FORGOT_PASSWORD_PAGE=${CLIENT_FORGOT_PASSWORD_PAGE}
            - CLIENT_OIDC_LOGIN_PAGE=${CLIENT_OIDC_LOGIN_PAGE}
            - CLIENT_OIDC_REGISTER_PAGE=${CLIENT_OIDC_REGISTER_PAGE}

            - PUBSUB_HOST=${PUBSUB_HOST}
            - PUBSUB_PORT=${PUBSUB_PORT}

            - DATABASE_PORT=${DATABASE_PORT}
            - DATABASE_USERNAME=${DATABASE_USERNAME}
            - DATABASE_PASSWORD=${DATABASE_PASSWORD}
            - DATABASE_HOST=${DATABASE_HOST}

            - PORT=80
            - JWT_SIGNING_SECRET=${JWT_SIGNING_SECRET}
            - JWT_EXPIRATION_TIME_IN_SECONDS=${JWT_EXPIRATION_TIME_IN_SECONDS}
            - REFRESH_TOKEN_SIGNING_SECRET=${REFRESH_TOKEN_SIGNING_SECRET}
            - REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS=${REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS}

            - AUTH_DATABASE_NAME=${AUTH_DATABASE_NAME}
            - AUTH_THROTTLE_LIMIT=${AUTH_THROTTLE_LIMIT}
            - AUTH_THROTTLE_TTL_IN_MS=${AUTH_THROTTLE_TTL_IN_MS}

            - USERS_DATABASE_NAME=${USERS_DATABASE_NAME}

            - MAIL_SENDER_NAME=${MAIL_SENDER_NAME}
            - MAIL_SENDER_USER=${MAIL_SENDER_USER}
            - MAIL_SENDER_PASSWORD=${MAIL_SENDER_PASSWORD}
            - MAIL_SENDER_HOST=${MAIL_SENDER_HOST}
            - MAIL_SENDER_PORT=${MAIL_SENDER_PORT}
            - MAIL_DEBUG_MODE=${MAIL_DEBUG_MODE}

            - MAIL_DATABASE_NAME=${MAIL_DATABASE_NAME}

            - ALERTS_DATABASE_NAME=${ALERTS_DATABASE_NAME}

            - JOURNAL_DATABASE_NAME=${JOURNAL_DATABASE_NAME}

            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            - GOOGLE_OIDC_REDIRECT_URL=${GOOGLE_OIDC_REDIRECT_URL}

            - COOKIES_SECRET=${COOKIES_SECRET}

    mail-service:
        ports:
            - "5200:80"
        environment:
            - CLIENT_URL_BASE=${CLIENT_URL_BASE}
            - CLIENT_ACCOUNT_ACTIVATION_PAGE=${CLIENT_ACCOUNT_ACTIVATION_PAGE}
            - CLIENT_FORGOT_PASSWORD_PAGE=${CLIENT_FORGOT_PASSWORD_PAGE}
            - CLIENT_OIDC_LOGIN_PAGE=${CLIENT_OIDC_LOGIN_PAGE}
            - CLIENT_OIDC_REGISTER_PAGE=${CLIENT_OIDC_REGISTER_PAGE}

            - PUBSUB_HOST=${PUBSUB_HOST}
            - PUBSUB_PORT=${PUBSUB_PORT}

            - DATABASE_PORT=${DATABASE_PORT}
            - DATABASE_USERNAME=${DATABASE_USERNAME}
            - DATABASE_PASSWORD=${DATABASE_PASSWORD}
            - DATABASE_HOST=${DATABASE_HOST}

            - PORT=80
            - JWT_SIGNING_SECRET=${JWT_SIGNING_SECRET}
            - JWT_EXPIRATION_TIME_IN_SECONDS=${JWT_EXPIRATION_TIME_IN_SECONDS}
            - REFRESH_TOKEN_SIGNING_SECRET=${REFRESH_TOKEN_SIGNING_SECRET}
            - REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS=${REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS}

            - AUTH_DATABASE_NAME=${AUTH_DATABASE_NAME}
            - AUTH_THROTTLE_LIMIT=${AUTH_THROTTLE_LIMIT}
            - AUTH_THROTTLE_TTL_IN_MS=${AUTH_THROTTLE_TTL_IN_MS}

            - USERS_DATABASE_NAME=${USERS_DATABASE_NAME}

            - MAIL_SENDER_NAME=${MAIL_SENDER_NAME}
            - MAIL_SENDER_USER=${MAIL_SENDER_USER}
            - MAIL_SENDER_PASSWORD=${MAIL_SENDER_PASSWORD}
            - MAIL_SENDER_HOST=${MAIL_SENDER_HOST}
            - MAIL_SENDER_PORT=${MAIL_SENDER_PORT}
            - MAIL_DEBUG_MODE=${MAIL_DEBUG_MODE}

            - MAIL_DATABASE_NAME=${MAIL_DATABASE_NAME}

            - ALERTS_DATABASE_NAME=${ALERTS_DATABASE_NAME}

            - JOURNAL_DATABASE_NAME=${JOURNAL_DATABASE_NAME}

            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            - GOOGLE_OIDC_REDIRECT_URL=${GOOGLE_OIDC_REDIRECT_URL}

            - COOKIES_SECRET=${COOKIES_SECRET}

    identity-service:
        ports:
            - "5300:80"
        environment:
            - CLIENT_URL_BASE=${CLIENT_URL_BASE}
            - CLIENT_ACCOUNT_ACTIVATION_PAGE=${CLIENT_ACCOUNT_ACTIVATION_PAGE}
            - CLIENT_FORGOT_PASSWORD_PAGE=${CLIENT_FORGOT_PASSWORD_PAGE}
            - CLIENT_OIDC_LOGIN_PAGE=${CLIENT_OIDC_LOGIN_PAGE}
            - CLIENT_OIDC_REGISTER_PAGE=${CLIENT_OIDC_REGISTER_PAGE}

            - PUBSUB_HOST=${PUBSUB_HOST}
            - PUBSUB_PORT=${PUBSUB_PORT}

            - DATABASE_PORT=${DATABASE_PORT}
            - DATABASE_USERNAME=${DATABASE_USERNAME}
            - DATABASE_PASSWORD=${DATABASE_PASSWORD}
            - DATABASE_HOST=${DATABASE_HOST}

            - PORT=80
            - JWT_SIGNING_SECRET=${JWT_SIGNING_SECRET}
            - JWT_EXPIRATION_TIME_IN_SECONDS=${JWT_EXPIRATION_TIME_IN_SECONDS}
            - REFRESH_TOKEN_SIGNING_SECRET=${REFRESH_TOKEN_SIGNING_SECRET}
            - REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS=${REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS}

            - AUTH_DATABASE_NAME=${AUTH_DATABASE_NAME}
            - AUTH_THROTTLE_LIMIT=${AUTH_THROTTLE_LIMIT}
            - AUTH_THROTTLE_TTL_IN_MS=${AUTH_THROTTLE_TTL_IN_MS}

            - USERS_DATABASE_NAME=${USERS_DATABASE_NAME}

            - MAIL_SENDER_NAME=${MAIL_SENDER_NAME}
            - MAIL_SENDER_USER=${MAIL_SENDER_USER}
            - MAIL_SENDER_PASSWORD=${MAIL_SENDER_PASSWORD}
            - MAIL_SENDER_HOST=${MAIL_SENDER_HOST}
            - MAIL_SENDER_PORT=${MAIL_SENDER_PORT}
            - MAIL_DEBUG_MODE=${MAIL_DEBUG_MODE}

            - MAIL_DATABASE_NAME=${MAIL_DATABASE_NAME}

            - ALERTS_DATABASE_NAME=${ALERTS_DATABASE_NAME}

            - JOURNAL_DATABASE_NAME=${JOURNAL_DATABASE_NAME}

            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            - GOOGLE_OIDC_REDIRECT_URL=${GOOGLE_OIDC_REDIRECT_URL}

            - COOKIES_SECRET=${COOKIES_SECRET}

    user-service:
        ports:
            - "5400:80"
        environment:
            - CLIENT_URL_BASE=${CLIENT_URL_BASE}
            - CLIENT_ACCOUNT_ACTIVATION_PAGE=${CLIENT_ACCOUNT_ACTIVATION_PAGE}
            - CLIENT_FORGOT_PASSWORD_PAGE=${CLIENT_FORGOT_PASSWORD_PAGE}
            - CLIENT_OIDC_LOGIN_PAGE=${CLIENT_OIDC_LOGIN_PAGE}
            - CLIENT_OIDC_REGISTER_PAGE=${CLIENT_OIDC_REGISTER_PAGE}

            - PUBSUB_HOST=${PUBSUB_HOST}
            - PUBSUB_PORT=${PUBSUB_PORT}

            - DATABASE_PORT=${DATABASE_PORT}
            - DATABASE_USERNAME=${DATABASE_USERNAME}
            - DATABASE_PASSWORD=${DATABASE_PASSWORD}
            - DATABASE_HOST=${DATABASE_HOST}

            - PORT=80
            - JWT_SIGNING_SECRET=${JWT_SIGNING_SECRET}
            - JWT_EXPIRATION_TIME_IN_SECONDS=${JWT_EXPIRATION_TIME_IN_SECONDS}
            - REFRESH_TOKEN_SIGNING_SECRET=${REFRESH_TOKEN_SIGNING_SECRET}
            - REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS=${REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS}

            - AUTH_DATABASE_NAME=${AUTH_DATABASE_NAME}
            - AUTH_THROTTLE_LIMIT=${AUTH_THROTTLE_LIMIT}
            - AUTH_THROTTLE_TTL_IN_MS=${AUTH_THROTTLE_TTL_IN_MS}

            - USERS_DATABASE_NAME=${USERS_DATABASE_NAME}

            - MAIL_SENDER_NAME=${MAIL_SENDER_NAME}
            - MAIL_SENDER_USER=${MAIL_SENDER_USER}
            - MAIL_SENDER_PASSWORD=${MAIL_SENDER_PASSWORD}
            - MAIL_SENDER_HOST=${MAIL_SENDER_HOST}
            - MAIL_SENDER_PORT=${MAIL_SENDER_PORT}
            - MAIL_DEBUG_MODE=${MAIL_DEBUG_MODE}

            - MAIL_DATABASE_NAME=${MAIL_DATABASE_NAME}

            - ALERTS_DATABASE_NAME=${ALERTS_DATABASE_NAME}

            - JOURNAL_DATABASE_NAME=${JOURNAL_DATABASE_NAME}

            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            - GOOGLE_OIDC_REDIRECT_URL=${GOOGLE_OIDC_REDIRECT_URL}

            - COOKIES_SECRET=${COOKIES_SECRET}

    journal-service:
        ports:
            - "5500:80"
        environment:
            - CLIENT_URL_BASE=${CLIENT_URL_BASE}
            - CLIENT_ACCOUNT_ACTIVATION_PAGE=${CLIENT_ACCOUNT_ACTIVATION_PAGE}
            - CLIENT_FORGOT_PASSWORD_PAGE=${CLIENT_FORGOT_PASSWORD_PAGE}
            - CLIENT_OIDC_LOGIN_PAGE=${CLIENT_OIDC_LOGIN_PAGE}
            - CLIENT_OIDC_REGISTER_PAGE=${CLIENT_OIDC_REGISTER_PAGE}

            - PUBSUB_HOST=${PUBSUB_HOST}
            - PUBSUB_PORT=${PUBSUB_PORT}

            - DATABASE_PORT=${DATABASE_PORT}
            - DATABASE_USERNAME=${DATABASE_USERNAME}
            - DATABASE_PASSWORD=${DATABASE_PASSWORD}
            - DATABASE_HOST=${DATABASE_HOST}

            - PORT=80
            - JWT_SIGNING_SECRET=${JWT_SIGNING_SECRET}
            - JWT_EXPIRATION_TIME_IN_SECONDS=${JWT_EXPIRATION_TIME_IN_SECONDS}
            - REFRESH_TOKEN_SIGNING_SECRET=${REFRESH_TOKEN_SIGNING_SECRET}
            - REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS=${REFRESH_TOKEN_EXPIRATION_TIME_IN_SECONDS}

            - AUTH_DATABASE_NAME=${AUTH_DATABASE_NAME}
            - AUTH_THROTTLE_LIMIT=${AUTH_THROTTLE_LIMIT}
            - AUTH_THROTTLE_TTL_IN_MS=${AUTH_THROTTLE_TTL_IN_MS}

            - USERS_DATABASE_NAME=${USERS_DATABASE_NAME}

            - MAIL_SENDER_NAME=${MAIL_SENDER_NAME}
            - MAIL_SENDER_USER=${MAIL_SENDER_USER}
            - MAIL_SENDER_PASSWORD=${MAIL_SENDER_PASSWORD}
            - MAIL_SENDER_HOST=${MAIL_SENDER_HOST}
            - MAIL_SENDER_PORT=${MAIL_SENDER_PORT}
            - MAIL_DEBUG_MODE=${MAIL_DEBUG_MODE}

            - MAIL_DATABASE_NAME=${MAIL_DATABASE_NAME}

            - ALERTS_DATABASE_NAME=${ALERTS_DATABASE_NAME}

            - JOURNAL_DATABASE_NAME=${JOURNAL_DATABASE_NAME}

            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            - GOOGLE_OIDC_REDIRECT_URL=${GOOGLE_OIDC_REDIRECT_URL}

            - COOKIES_SECRET=${COOKIES_SECRET}
